#!/bin/sh
#
# Update the Formula for a new version.
#
# Usage: bin/release VERSION
#
# Requires sha1sum be installed.
#
###
set -e

if [ -z "$1" ]; then
  echo "usage: bin/release VERSION" >&2
  exit 64
fi

version=$1
formula=Formula/codeclimate.rb

if ! command -v sha1sum > /dev/null 2>&1; then
  echo "Please install the md5sha1sum package (`brew install md5sha1sum` on OS X)."
  exit 1
fi


sha1=$(curl -sL "https://github.com/codeclimate/codeclimate/archive/v$version.tar.gz" | sha1sum | cut -d " " -f 1)

git checkout master
git pull

sed 's/^\(.*CODECLIMATE_VERSION = "\).*\(".*\)$/\1'"$version"'\2/' "$formula" > "$formula.modified"
sed 's/^\(.*sha1 "\).*\(".*\)$/\1'"$sha1"'\2/' "$formula.modified" > "$formula"
rm "$formula.modified"

git add "$formula"
git commit -m "Release v$version"
git show
git push
